import { EthAddress, GrumpkinAddress } from '@aztec/barretenberg/address';
import { BridgeCallData } from '@aztec/barretenberg/bridge_call_data';
import { ProofData, ProofId } from '@aztec/barretenberg/client_proofs';
import { randomBytes } from '@aztec/barretenberg/crypto';
import { Grumpkin } from '@aztec/barretenberg/ecc';
import { HashPath, MemoryMerkleTree } from '@aztec/barretenberg/merkle_tree';
import { ClaimNoteTxData, deriveNoteSecret, TreeNote } from '@aztec/barretenberg/note_algorithms';
import { WorldStateConstants } from '@aztec/barretenberg/world_state';
import { Note } from '../../note/index.js';
export class JoinSplitTxInputCreator {
    constructor(noteAlgos, grumpkin, pedersen) {
        this.noteAlgos = noteAlgos;
        this.grumpkin = grumpkin;
        this.pedersen = pedersen;
    }
    async createTx(accountPublicKey, proofId, assetId, publicValue, publicOwner, recipientPrivateOutput, senderPrivateOutput, bridgeCallData, defiDepositValue, recipient, recipientSpendingKeyRequired, inputNotes, { spendingPublicKey, aliasHash, accountIndex, accountPath }, dataRoot, allowChain, hideNoteCreator, authAlgos) {
        if (inputNotes.length > 2) {
            throw new Error('Cannot create a proof with more than 2 input notes.');
        }
        if (inputNotes.reduce((count, n) => count + (n.allowChain ? 1 : 0), 0) > 1) {
            throw new Error('Cannot chain from more than one pending note.');
        }
        const accountSpendingKeyRequired = !spendingPublicKey.equals(accountPublicKey);
        const notes = [...inputNotes];
        // Add gibberish notes to ensure we have two notes.
        for (let i = notes.length; i < 2; ++i) {
            notes.push(await this.createGibberishNote(accountPublicKey, accountSpendingKeyRequired, assetId, authAlgos));
        }
        const zeroHashPath = HashPath.ZERO(WorldStateConstants.DATA_TREE_DEPTH, MemoryMerkleTree.ZERO_ELEMENT, this.pedersen).toBuffer();
        const completeInputNotes = notes.map(n => n.hashPath
            ? n
            : new Note(n.treeNote, n.commitment, n.nullifier, n.allowChain, n.nullified, n.index, zeroHashPath));
        const newNotes = [
            await this.createNote(assetId, recipientPrivateOutput, recipient, recipientSpendingKeyRequired, notes[0].nullifier, ProofData.allowChainFromNote1(allowChain), hideNoteCreator ? GrumpkinAddress.ZERO : accountPublicKey, authAlgos),
            await this.createNote(assetId, senderPrivateOutput, accountPublicKey, accountSpendingKeyRequired, notes[1].nullifier, ProofData.allowChainFromNote2(allowChain), hideNoteCreator ? GrumpkinAddress.ZERO : accountPublicKey, authAlgos),
        ];
        const claimNote = proofId === ProofId.DEFI_DEPOSIT
            ? this.createClaimNote(bridgeCallData, defiDepositValue, accountPublicKey, notes[0].nullifier)
            : { note: ClaimNoteTxData.EMPTY, ephPubKey: GrumpkinAddress.ZERO };
        const propagatedInputIndex = 1 + inputNotes.findIndex(n => n.allowChain);
        const backwardLink = propagatedInputIndex ? inputNotes[propagatedInputIndex - 1].commitment : Buffer.alloc(32);
        const tx = {
            proofId,
            publicValue,
            publicOwner,
            inputNotes: completeInputNotes,
            outputNotes: newNotes.map(n => n.note),
            claimNote: claimNote.note,
            spendingPublicKey,
            aliasHash,
            accountIndex,
            accountPath,
            dataRoot,
            backwardLink,
            allowChain,
        };
        const viewingKeys = proofId === ProofId.DEFI_DEPOSIT ? [newNotes[1].viewingKey] : [newNotes[0].viewingKey, newNotes[1].viewingKey];
        const signingData = await authAlgos.createJoinSplitProofSigningData(tx);
        return {
            tx,
            viewingKeys,
            partialStateSecretEphPubKey: claimNote.ephPubKey,
            signingData,
            outputNotes: newNotes.map(n => n.note),
        };
    }
    /**
     * This method creates a chain of J/S txs to merge 3 or more notes and produces 2 output notes.
     * We do this by splitting the notes into settled and pending (there must be at most 1 pending note!).
     * Then we pair a settled note with a settled/pending note to produce a pending output note.
     * Then we pair that pending output note with another settled note to produce a new pending output note.
     * Repeat this until we have 2 notes remaining, one pending and one settled.
     */
    async createChainedTxs(accountPublicKey, assetId, notes, spendingKeyAccount, dataRoot, authAlgos) {
        if (notes.length <= 2) {
            throw new Error(`Can only merge 3 or more notes. Got ${notes.length}.`);
        }
        const settledNotes = notes.filter(n => !n.pending);
        let firstNote = notes.find(n => n.pending) || settledNotes.shift();
        const lastNote = settledNotes.pop();
        // Create chained txs to generate 2 output notes.
        const proofInputs = [];
        for (const note of settledNotes) {
            const inputNotes = [firstNote, note];
            const noteSum = inputNotes.reduce((sum, n) => sum + n.value, BigInt(0));
            const { tx, viewingKeys, signingData, outputNotes } = await this.createTx(accountPublicKey, ProofId.SEND, assetId, BigInt(0), // publicValue
            EthAddress.ZERO, BigInt(0), // recipientPrivateOutput
            noteSum, // senderPrivateOutput
            BridgeCallData.ZERO, BigInt(0), // defiDepositValue
            GrumpkinAddress.generator(), // recipient
            false, // recipientSpendingKeyRequired
            inputNotes, spendingKeyAccount, dataRoot, 2, // allowChain
            false, // hideNoteCreator
            authAlgos);
            proofInputs.push({ tx, viewingKeys, signingData });
            firstNote = outputNotes[1];
        }
        const outputNotes = [firstNote, lastNote];
        return { proofInputs, outputNotes };
    }
    async createGibberishNote(owner, spendingKeyRequired, assetId, authAlgos) {
        const treeNote = TreeNote.createFromEphPriv(owner, BigInt(0), // value
        assetId, spendingKeyRequired, randomBytes(32), // inputNullifier - this is a dummy input nullifier for the dummy note.
        this.createEphemeralPrivKey(), this.grumpkin);
        const commitment = this.noteAlgos.valueNoteCommitment(treeNote);
        const nullifier = await authAlgos.computeValueNoteNullifier(commitment, true);
        return new Note(treeNote, commitment, nullifier, false, false);
    }
    async createNote(assetId, value, owner, spendingKeyRequired, inputNullifier, allowChain, creator, authAlgos) {
        const { ephPrivKey } = this.createEphemeralKeyPair();
        const treeNote = TreeNote.createFromEphPriv(owner, value, assetId, spendingKeyRequired, inputNullifier, ephPrivKey, this.grumpkin, creator.x());
        const viewingKey = treeNote.createViewingKey(ephPrivKey, this.grumpkin);
        const commitment = this.noteAlgos.valueNoteCommitment(treeNote);
        const nullifier = await authAlgos.computeValueNoteNullifier(commitment, false);
        const note = new Note(treeNote, commitment, nullifier, allowChain, false);
        return { note, viewingKey };
    }
    createClaimNote(bridgeCallData, value, owner, inputNullifier) {
        const { ephPrivKey, ephPubKey } = this.createEphemeralKeyPair();
        const noteSecret = deriveNoteSecret(owner, ephPrivKey, this.grumpkin);
        const note = new ClaimNoteTxData(value, bridgeCallData, noteSecret, inputNullifier);
        // ephPubKey is returned for the defi deposit use case, where we'd like to avoid creating a viewing key for the
        // partial claim note's partialState, since all we want to transmit is the ephPubKey (which we can do via offchain tx data).
        return { note, ephPubKey };
    }
    createEphemeralPrivKey() {
        return this.grumpkin.getRandomFr();
    }
    createEphemeralKeyPair() {
        const ephPrivKey = this.grumpkin.getRandomFr();
        const ephPubKey = new GrumpkinAddress(this.grumpkin.mul(Grumpkin.generator, ephPrivKey));
        return { ephPrivKey, ephPubKey };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbl9zcGxpdF90eF9pbnB1dF9jcmVhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Byb29mcy9wcm9vZl9pbnB1dC9qb2luX3NwbGl0X3R4X2lucHV0X2NyZWF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUMxRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN2RSxPQUFPLEVBQVksV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ25ELE9BQU8sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUM3RSxPQUFPLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFrQixRQUFRLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNsSCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUV0RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFLM0MsTUFBTSxPQUFPLHVCQUF1QjtJQUNsQyxZQUFvQixTQUF5QixFQUFVLFFBQWtCLEVBQVUsUUFBa0I7UUFBakYsY0FBUyxHQUFULFNBQVMsQ0FBZ0I7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUFHLENBQUM7SUFFekcsS0FBSyxDQUFDLFFBQVEsQ0FDWixnQkFBaUMsRUFDakMsT0FBZ0IsRUFDaEIsT0FBZSxFQUNmLFdBQW1CLEVBQ25CLFdBQXVCLEVBQ3ZCLHNCQUE4QixFQUM5QixtQkFBMkIsRUFDM0IsY0FBOEIsRUFDOUIsZ0JBQXdCLEVBQ3hCLFNB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