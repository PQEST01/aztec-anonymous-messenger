import { TxType } from '@aztec/barretenberg/blockchain';
import { DefiSettlementTime, TxSettlementTime } from '@aztec/barretenberg/rollup_provider';
import { roundUp } from '@aztec/barretenberg/rounding';
export class TxValueCalculator {
    constructor(core, blockchain) {
        this.core = core;
        this.blockchain = blockchain;
    }
    async getMaxWithdrawValue(userId, assetId, { recipient, ...options } = {}) {
        const txType = recipient && !(await this.blockchain.isContract(recipient)) && !(await this.blockchain.isEmpty(recipient))
            ? TxType.WITHDRAW_TO_WALLET
            : TxType.WITHDRAW_HIGH_GAS;
        return await this.getMaxTxValueFromTxType(userId, assetId, txType, options);
    }
    async getMaxTransferValue(userId, assetId, options = {}) {
        return await this.getMaxTxValueFromTxType(userId, assetId, TxType.TRANSFER, options);
    }
    async getMaxDefiValue(userId, bridgeCallData, { txSettlementTime = DefiSettlementTime.DEADLINE, ...options } = {}) {
        const fee = (await this.core.getDefiFees(bridgeCallData))[txSettlementTime];
        const feeAssetId = fee.assetId;
        const assetIdA = bridgeCallData.inputAssetIdA;
        if (bridgeCallData.inputAssetIdB === undefined) {
            const txFees = await this.core.getTxFees(feeAssetId);
            const [transferFee] = txFees[TxType.TRANSFER];
            return await this.getMaxTxValueFromFee(userId, assetIdA, fee, transferFee, options);
        }
        const assetIdB = bridgeCallData.inputAssetIdB;
        const [transferFee] = (await this.core.getTxFees(feeAssetId))[TxType.TRANSFER];
        const { userSpendingKeyRequired, excludePendingNotes, feeSignificantFigures = 0 } = options;
        let maxValue = BigInt(0);
        let maxFee = BigInt(0);
        // Get the number of merges needed to create the exact note value for an asset.
        const getNumMerges = async (assetId, value, excludePendingNotes) => {
            const notes = await this.core.pickNotes(userId, assetId, value, userSpendingKeyRequired, excludePendingNotes);
            if (!notes.length) {
                return {};
            }
            const note = await this.core.pickNote(userId, assetId, value, userSpendingKeyRequired, excludePendingNotes);
            if (note?.value === value) {
                return { numMerges: 0, pendingIncluded: note.pending };
            }
            else {
                return { numMerges: Math.max(1, notes.length - 1), pendingIncluded: notes.some(n => n.pending) };
            }
        };
        const feeNoteValues = feeAssetId !== assetIdA
            ? (await this.core.getMaxSpendableNoteValues(userId, feeAssetId, userSpendingKeyRequired, excludePendingNotes)).sort((a, b) => (a < b ? -1 : 1))
            : [];
        const getRequiredFee = (numMerges) => {
            let numFeeNotes = 1;
            while (numFeeNotes <= feeNoteValues.length) {
                const feeNotesSum = feeNoteValues.slice(-numFeeNotes).reduce((sum, n) => sum + n, BigInt(0));
                const feeNumTxs = Math.max(1, numFeeNotes - 1);
                const requiredFee = roundUp(fee.value + transferFee.value * BigInt(numMerges + feeNumTxs), feeSignificantFigures);
                if (requiredFee <= feeNotesSum) {
                    return requiredFee;
                }
                numFeeNotes++;
            }
        };
        // Pick one note for assetB. Pick one note or merge notes for assetA.
        const noteValuesB = (await this.core.getSpendableNoteValues(userId, assetIdB, userSpendingKeyRequired, excludePendingNotes)).sort((a, b) => (a > b ? -1 : 1));
        for (const noteValue of noteValuesB) {
            if (noteValue < maxValue) {
                continue;
            }
            const isPending = (await this.core.pickNote(userId, assetIdB, noteValue, userSpendingKeyRequired, true))?.value !== noteValue;
            if (assetIdA !== feeAssetId) {
                const { numMerges } = await getNumMerges(assetIdA, noteValue, excludePendingNotes || isPending);
                if (numMerges === undefined) {
                    continue;
                }
                const requiredFee = getRequiredFee(numMerges);
                if (requiredFee) {
                    maxValue = noteValue;
                    maxFee = requiredFee;
                    break;
                }
            }
            else {
                const spendableValue = await this.core.getSpendableSum(userId, assetIdA, userSpendingKeyRequired, excludePendingNotes || isPending);
                let numMerges = 0;
                let requiredValue = noteValue + roundUp(fee.value, feeSignificantFigures);
                while (requiredValue <= spendableValue) {
                    if ((await getNumMerges(assetIdA, requiredValue, excludePendingNotes || isPending)).numMerges === numMerges) {
                        maxValue = noteValue;
                        maxFee = requiredValue - noteValue;
                        break;
                    }
                    numMerges++;
                    requiredValue = noteValue + roundUp(fee.value + transferFee.value * BigInt(numMerges), feeSignificantFigures);
                }
            }
        }
        // Pick one note for assetA. Pick one note or merge notes for assetB.
        const noteValuesA = (await this.core.getSpendableNoteValues(userId, assetIdA, userSpendingKeyRequired, excludePendingNotes)).sort((a, b) => (a > b ? -1 : 1));
        for (const noteValue of noteValuesA) {
            if (noteValue < maxValue) {
                break;
            }
            const isPending = (await this.core.pickNote(userId, assetIdA, noteValue, userSpendingKeyRequired, true))?.value !== noteValue;
            if (assetIdA !== feeAssetId) {
                const { numMerges, pendingIncluded } = await getNumMerges(assetIdB, noteValue, excludePendingNotes ?? false);
                if (numMerges === undefined || (pendingIncluded && isPending)) {
                    continue;
                }
                const requiredFee = getRequiredFee(numMerges);
                if (requiredFee) {
                    maxValue = noteValue;
                    maxFee = requiredFee;
                    break;
                }
            }
            else {
                const spendableValue = await this.core.getSpendableSum(userId, assetIdB, userSpendingKeyRequired, excludePendingNotes ?? false);
                let requiredNumMerges = 0;
                let requiredValue = noteValue - roundUp(fee.value, feeSignificantFigures);
                while (requiredValue > maxValue) {
                    if (requiredValue <= spendableValue) {
                        const { numMerges, pendingIncluded } = await getNumMerges(assetIdB, requiredValue, excludePendingNotes ?? false);
                        if (numMerges === requiredNumMerges && (!pendingIncluded || !isPending)) {
                            maxValue = requiredValue;
                            maxFee = roundUp(fee.value + transferFee.value * BigInt(requiredNumMerges), feeSignificantFigures);
                            break;
                        }
                    }
                    requiredNumMerges++;
                    requiredValue =
                        noteValue - roundUp(fee.value + transferFee.value * BigInt(requiredNumMerges), feeSignificantFigures);
                }
            }
        }
        return { assetId: bridgeCallData.inputAssetIdA, value: maxValue, fee: { assetId: feeAssetId, value: maxFee } };
    }
    async getMaxTxValueFromTxType(userId, assetId, txType, { txSettlementTime = TxSettlementTime.NEXT_ROLLUP, ...options }) {
        const txFees = await this.core.getTxFees(assetId);
        const fee = txFees[txType][txSettlementTime];
        const [transferFee] = txFees[TxType.TRANSFER];
        return await this.getMaxTxValueFromFee(userId, assetId, fee, transferFee, options);
    }
    async getMaxTxValueFromFee(userId, assetId, fee, transferFee, { userSpendingKeyRequired = false, excludePendingNotes = false, feeSignificantFigures = 0 }) {
        const noteValues = (await this.core.getMaxSpendableNoteValues(userId, assetId, userSpendingKeyRequired, excludePendingNotes)).sort((a, b) => (a > b ? -1 : 1));
        let numNotes = noteValues.length;
        let maxValue = BigInt(0);
        let maxFee = BigInt(0);
        if (fee.assetId !== assetId) {
            const feeNoteValues = (await this.core.getMaxSpendableNoteValues(userId, fee.assetId, userSpendingKeyRequired, excludePendingNotes)).sort((a, b) => (a < b ? -1 : 1));
            const getRequiredFee = (numMerges) => {
                let numFeeNotes = 1;
                while (numFeeNotes <= feeNoteValues.length) {
                    const spendableFee = feeNoteValues.slice(0, numFeeNotes).reduce((sum, n) => sum + n, BigInt(0));
                    const feeNumTxs = Math.max(1, numFeeNotes - 1);
                    const requiredFee = roundUp(fee.value + transferFee.value * BigInt(numMerges + feeNumTxs), feeSignificantFigures);
                    if (requiredFee <= spendableFee) {
                        return requiredFee;
                    }
                    numFeeNotes++;
                }
            };
            while (numNotes > 0) {
                const numMerges = Math.max(0, numNotes - 2);
                const requiredFee = getRequiredFee(numMerges);
                if (requiredFee) {
                    const noteSum = noteValues.slice(0, numNotes).reduce((sum, n) => sum + n, BigInt(0));
                    maxValue = noteSum;
                    maxFee = requiredFee;
                    break;
                }
                numNotes--;
            }
        }
        else {
            while (numNotes > 0) {
                const numMerges = Math.max(0, numNotes - 2);
                const noteSum = noteValues.slice(0, numNotes).reduce((sum, n) => sum + n, BigInt(0));
                const requiredFee = roundUp(fee.value + transferFee.value * BigInt(numMerges), feeSignificantFigures);
                const value = noteSum - requiredFee;
                if (value > maxValue || (value === maxValue && requiredFee < maxFee)) {
                    maxValue = value;
                    maxFee = requiredFee;
                }
                numNotes--;
            }
        }
        return { assetId, value: maxValue, fee: { assetId: fee.assetId, value: maxFee } };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHhfdmFsdWVfY2FsY3VsYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9henRlY19zZGsvdHhfdmFsdWVfY2FsY3VsYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFeEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDM0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBV3ZELE1BQU0sT0FBTyxpQkFBaUI7SUFDNUIsWUFBNkIsSUFBYSxFQUFtQixVQUFvQztRQUFwRSxTQUFJLEdBQUosSUFBSSxDQUFTO1FBQW1CLGVBQVUsR0FBVixVQUFVLENBQTBCO0lBQUcsQ0FBQztJQUU5RixLQUFLLENBQUMsbUJBQW1CLENBQzlCLE1BQXVCLEVBQ3ZCLE9BQWUsRUFDZixFQUFFLFNBQVMsRUFBRSxHQUFHLE9BQU8sS0FBd0QsRUFBRTtRQUVqRixNQUFNLE1BQU0sR0FDVixTQUFTLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN4RyxDQUFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQjtZQUMzQixDQUFDLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDO1FBQy9CLE9BQU8sTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVNLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUF1QixFQUFFLE9BQWUsRUFBRSxVQUFnQyxFQUFFO1FBQzNHLE9BQU8sTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZGLENBQUM7SUFFTSxLQUFLLENBQUMsZUFBZSxDQUMxQixNQUF1QixFQUN2QixjQUE4QixFQUM5QixFQUNFLGdCQUFnQixHQUFHLGtCQUFrQixDQUFDLFFBQVEsRUFDOUMsR0FBRyxPQUFPLEtBQ29GLEVBQUU7UUFFbEcsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUM1RSxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO1FBQy9CLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxhQUFhLENBQUM7UUFDOUMsSUFBSSxjQUFjLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUM5QyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlDLE9BQU8sTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3JGO1FBRUQsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQztRQUM5QyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9FLE1BQU0sRUFBRSx1QkFBdUIsRUFBRSxtQkFBbUIsRUFBRSxxQkFBcUIsR0FBRyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDNUYsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV2QiwrRUFBK0U7UUFDL0UsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLE9BQWUsRUFBRSxLQUFhLEVBQUUsbUJBQTRCLEVBQUUsRUFBRTtZQUMxRixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDOUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7Z0JBQ2pCLE9BQU8sRUFBRSxDQUFDO2FBQ1g7WUFDRCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDNUcsSUFBSSxJQUFJLEVBQUUsS0FBSyxLQUFLLEtBQUssRUFBRTtnQkFDekIsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsZUFBZSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUN4RDtpQkFBTTtnQkFDTCxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUUsZUFBZSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQzthQUNsRztRQUNILENBQUMsQ0FBQztRQUVGLE1BQU0sYUFBYSxHQUNqQixVQUFVLEtBQUssUUFBUTtZQUNyQixDQUFDLENBQUMsQ0FDRSxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSx1QkFBdUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUM1RyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDVCxNQUFNLGNBQWMsR0FBRyxDQUFDLFNBQWlCLEVBQUUsRUFBRTtZQUMzQyxJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7WUFDcEIsT0FBTyxXQUFXLElBQUksYUFBYSxDQUFDLE1BQU0sRUFBRTtnQkFDMUMsTUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDL0MsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUN6QixHQUFHLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsRUFDN0QscUJBQXFCLENBQ3RCLENBQUM7Z0JBQ0YsSUFBSSxXQUFXLElBQUksV0FBVyxFQUFFO29CQUM5QixPQUFPLFdBQVcsQ0FBQztpQkFDcEI7Z0JBQ0QsV0FBVyxFQUFFLENBQUM7YUFDZjtRQUNILENBQUMsQ0FBQztRQUVGLHFFQUFxRTtRQUNyRSxNQUFNLFdBQVcsR0FBRyxDQUNsQixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSx1QkFBdUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUN2RyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsS0FBSyxNQUFNLFNBQVMsSUFBSSxXQUFXLEVBQUU7WUFDbkMsSUFBSSxTQUFTLEdBQUcsUUFBUSxFQUFFO2dCQUN4QixTQUFTO2FBQ1Y7WUFDRCxNQUFNLFNBQVMsR0FDYixDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLENBQUMsRUFBRSxLQUFLLEtBQUssU0FBUyxDQUFDO1lBQzlHLElBQUksUUFBUSxLQUFLLFVBQVUsRUFBRTtnQkFDM0IsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsbUJBQW1CLElBQUksU0FBUyxDQUFDLENBQUM7Z0JBQ2hHLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtvQkFDM0IsU0FBUztpQkFDVjtnQkFDRCxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlDLElBQUksV0FBVyxFQUFFO29CQUNmLFFBQVEsR0FBRyxTQUFTLENBQUM7b0JBQ3JCLE1BQU0sR0FBRyxXQUFXLENBQUM7b0JBQ3JCLE1BQU07aUJBQ1A7YUFDRjtpQkFBTTtnQkFDTCxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUNwRCxNQUFNLEVBQ04sUUFBUSxFQUNSLHVCQUF1QixFQUN2QixtQkFBbUIsSUFBSSxTQUFTLENBQ2pDLENBQUM7Z0JBQ0YsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQixJQUFJLGFBQWEsR0FBRyxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUscUJBQXFCLENBQUMsQ0FBQztnQkFDMUUsT0FBTyxhQUFhLElBQUksY0FBYyxFQUFFO29CQUN0QyxJQUFJLENBQUMsTUFBTSxZQUFZLENBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRSxtQkFBbUIsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7d0JBQzNHLFFBQVEsR0FBRyxTQUFTLENBQUM7d0JBQ3JCLE1BQU0sR0FBRyxhQUFhLEdBQUcsU0FBUyxDQUFDO3dCQUNuQyxNQUFNO3FCQUNQO29CQUNELFNBQVMsRUFBRSxDQUFDO29CQUNaLGFBQWEsR0FBRyxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUscUJBQXFCLENBQUMsQ0FBQztpQkFDL0c7YUFDRjtTQUNGO1FBRUQscUVBQXFFO1FBQ3JFLE1BQU0sV0FBVyxHQUFHLENBQ2xCLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLHVCQUF1QixFQUFFLG1CQUFtQixDQUFDLENBQ3ZHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQyxLQUFLLE1BQU0sU0FBUyxJQUFJLFdBQVcsRUFBRTtZQUNuQyxJQUFJLFNBQVMsR0FBRyxRQUFRLEVBQUU7Z0JBQ3hCLE1BQU07YUFDUDtZQUNELE1BQU0sU0FBUyxHQUNiLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSx1QkFBdUIsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLEtBQUssS0FBSyxTQUFTLENBQUM7WUFDOUcsSUFBSSxRQUFRLEtBQUssVUFBVSxFQUFFO2dCQUMzQixNQUFNLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsbUJBQW1CLElBQUksS0FBSyxDQUFDLENBQUM7Z0JBQzdHLElBQUksU0FBUyxLQUFLLFNBQVMsSUFBSSxDQUFDLGVBQWUsSUFBSSxTQUFTLENBQUMsRUFBRTtvQkFDN0QsU0FBUztpQkFDVjtnQkFDRCxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlDLElBQUksV0FBVyxFQUFFO29CQUNmLFFBQVEsR0FBRyxTQUFTLENBQUM7b0JBQ3JCLE1BQU0sR0FBRyxXQUFXLENBQUM7b0JBQ3JCLE1BQU07aUJBQ1A7YUFDRjtpQkFBTTtnQkFDTCxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUNwRCxNQUFNLEVBQ04sUUFBUSxFQUNSLHVCQUF1QixFQUN2QixtQkFBbUIsSUFBSSxLQUFLLENBQzdCLENBQUM7Z0JBQ0YsSUFBSSxpQkFBaUIsR0FBRyxDQUFDLENBQUM7Z0JBQzFCLElBQUksYUFBYSxHQUFHLFNBQVMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO2dCQUMxRSxPQUFPLGFBQWEsR0FBRyxRQUFRLEVBQUU7b0JBQy9CLElBQUksYUFBYSxJQUFJLGNBQWMsRUFBRTt3QkFDbkMsTUFBTSxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsR0FBRyxNQUFNLFlBQVksQ0FDdkQsUUFBUSxFQUNSLGFBQWEsRUFDYixtQkFBbUIsSUFBSSxLQUFLLENBQzdCLENBQUM7d0JBQ0YsSUFBSSxTQUFTLEtBQUssaUJBQWlCLElBQUksQ0FBQyxDQUFDLGVBQWUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFOzRCQUN2RSxRQUFRLEdBQUcsYUFBYSxDQUFDOzRCQUN6QixNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsaUJBQWlCLENBQUMsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDOzRCQUNuRyxNQUFNO3lCQUNQO3FCQUNGO29CQUNELGlCQUFpQixFQUFFLENBQUM7b0JBQ3BCLGFBQWE7d0JBQ1gsU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDLEVBQUUscUJBQXFCLENBQUMsQ0FBQztpQkFDekc7YUFDRjtTQUNGO1FBRUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxjQUFjLENBQUMsYUFBYSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQztJQUNqSCxDQUFDO0lBRU8sS0FBSyxDQUFDLHVCQUF1QixDQUNuQyxNQUF1QixFQUN2QixPQUFlLEVBQ2YsTUFBYyxFQUNkLEVBQUUsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLEdBQUcsT0FBTyxFQUF3QjtRQUVyRixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JGLENBQUM7SUFFTyxLQUFLLENBQUMsb0JBQW9CLENBQ2hDLE1BQXVCLEVBQ3ZCLE9BQWUsRUFDZixHQUFlLEVBQ2YsV0FBdUIsRUFDdkIsRUFBRSx1QkFBdUIsR0FBRyxLQUFLLEVBQUUsbUJBQW1CLEdBQUcsS0FBSyxFQUFFLHFCQUFxQixHQUFHLENBQUMsRUFBd0I7UUFFakgsTUFBTSxVQUFVLEdBQUcsQ0FDakIsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsbUJBQW1CLENBQUMsQ0FDekcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLElBQUksUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7UUFDakMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV2QixJQUFJLEdBQUcsQ0FBQyxPQUFPLEtBQUssT0FBTyxFQUFFO1lBQzNCLE1BQU0sYUFBYSxHQUFHLENBQ3BCLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxtQkFBbUIsQ0FBQyxDQUM3RyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxjQUFjLEdBQUcsQ0FBQyxTQUFpQixFQUFFLEVBQUU7Z0JBQzNDLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztnQkFDcEIsT0FBTyxXQUFXLElBQUksYUFBYSxDQUFDLE1BQU0sRUFBRTtvQkFDMUMsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDaEcsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUMvQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQ3pCLEdBQUcsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxFQUM3RCxxQkFBcUIsQ0FDdEIsQ0FBQztvQkFDRixJQUFJLFdBQVcsSUFBSSxZQUFZLEVBQUU7d0JBQy9CLE9BQU8sV0FBVyxDQUFDO3FCQUNwQjtvQkFDRCxXQUFXLEVBQUUsQ0FBQztpQkFDZjtZQUNILENBQUMsQ0FBQztZQUNGLE9BQU8sUUFBUSxHQUFHLENBQUMsRUFBRTtnQkFDbkIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM1QyxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlDLElBQUksV0FBVyxFQUFFO29CQUNmLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3JGLFFBQVEsR0FBRyxPQUFPLENBQUM7b0JBQ25CLE1BQU0sR0FBRyxXQUFXLENBQUM7b0JBQ3JCLE1BQU07aUJBQ1A7Z0JBQ0QsUUFBUSxFQUFFLENBQUM7YUFDWjtTQUNGO2FBQU07WUFDTCxPQUFPLFFBQVEsR0FBRyxDQUFDLEVBQUU7Z0JBQ25CLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckYsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUscUJBQXFCLENBQUMsQ0FBQztnQkFDdEcsTUFBTSxLQUFLLEdBQUcsT0FBTyxHQUFHLFdBQVcsQ0FBQztnQkFDcEMsSUFBSSxLQUFLLEdBQUcsUUFBUSxJQUFJLENBQUMsS0FBSyxLQUFLLFFBQVEsSUFBSSxXQUFXLEdBQUcsTUFBTSxDQUFDLEVBQUU7b0JBQ3BFLFFBQVEsR0FBRyxLQUFLLENBQUM7b0JBQ2pCLE1BQU0sR0FBRyxXQUFXLENBQUM7aUJBQ3RCO2dCQUNELFFBQVEsRUFBRSxDQUFDO2FBQ1o7U0FDRjtRQUNELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQztJQUNwRixDQUFDO0NBQ0YifQ==